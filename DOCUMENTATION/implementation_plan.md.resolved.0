# Swap + Bridge dApp — Implementation Plan

## Overview

Build a production-ready, single-screen **Swap + Bridge dApp** using Next.js (App Router) + TypeScript + TailwindCSS. Supports 8 EVM chains + Solana, with a unified routing engine and mode toggle (AUTO / SWAP ONLY / BRIDGE ONLY).

---

## Provider Decisions

| Category | Provider | Reason |
|---|---|---|
| **EVM Swap** | **1inch Swap API v6** | Best aggregator coverage, clean `swap`/`quote` endpoints, free tier available |
| **Solana Swap** | **Jupiter v6 API** | Standard Solana swap aggregator, returns `swapTransaction` as base64 |
| **Bridge** | **LI.FI API** | Aggregates 20+ bridges, supports swap+bridge+swap routes, status tracking via `getStatus` |

All three providers expose REST APIs. Keys go in env vars; `MOCK_MODE=1` returns deterministic fixtures.

---

## Supported Chains (Default)

| Chain | ID | Type |
|---|---|---|
| Ethereum | 1 | EVM |
| Arbitrum | 42161 | EVM |
| Optimism | 10 | EVM |
| Base | 8453 | EVM |
| Polygon | 137 | EVM |
| BNB Chain | 56 | EVM |
| Avalanche | 43114 | EVM |
| Canto | 7700 | EVM |
| Solana | `solana` | SVM |

---

## File Tree (Step A)

```
swap-bridge-dapp/
├── .env.example
├── .gitignore
├── next.config.ts
├── package.json
├── tsconfig.json
├── tailwind.config.ts
├── postcss.config.mjs
├── vitest.config.ts
├── README.md
│
├── public/
│   └── favicon.ico
│
├── src/
│   ├── app/
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   ├── globals.css
│   │   ├── providers.tsx               # wagmi + solana + tanstack-query providers
│   │   └── api/
│   │       ├── quote/
│   │       │   └── route.ts            # POST — unified quote endpoint
│   │       ├── swap/
│   │       │   └── route.ts            # POST — build swap tx
│   │       ├── bridge/
│   │       │   ├── route.ts            # POST — get bridge route + steps
│   │       │   └── status/
│   │       │       └── route.ts        # GET — poll bridge status
│   │       └── tokens/
│   │           └── route.ts            # GET — dynamic token search
│   │
│   ├── components/
│   │   ├── SwapBridgeApp.tsx           # main single-screen orchestrator
│   │   ├── ModeToggle.tsx              # AUTO / SWAP ONLY / BRIDGE ONLY
│   │   ├── ChainSelector.tsx           # chain dropdown (EVM + Solana)
│   │   ├── TokenSelector.tsx           # token picker with search
│   │   ├── AmountInput.tsx             # amount field with balance display
│   │   ├── QuotePanel.tsx              # quote details: rate, fees, route, impact, ETA
│   │   ├── TransactionStepper.tsx      # step-by-step tx progress
│   │   ├── WalletConnectButton.tsx     # EVM + Solana connect buttons
│   │   └── ui/                         # shared primitives
│   │       ├── Button.tsx
│   │       ├── Modal.tsx
│   │       ├── Spinner.tsx
│   │       └── Badge.tsx
│   │
│   ├── lib/
│   │   ├── chains/
│   │   │   └── chainConfig.ts          # chain definitions, RPCs, explorer URLs
│   │   ├── tokens/
│   │   │   └── tokenList.ts            # static token list (CANTO included)
│   │   ├── routing/
│   │   │   ├── routingEngine.ts        # deterministic route resolver
│   │   │   └── modeEnforcement.ts      # mode rules + error messages
│   │   ├── schemas/
│   │   │   ├── quote.ts               # zod: QuoteRequest, QuoteResponse
│   │   │   ├── route.ts               # zod: Route, RouteStep
│   │   │   ├── transaction.ts         # zod: TxRequest, TxReceipt
│   │   │   └── status.ts             # zod: StatusResponse, StatusState
│   │   ├── adapters/
│   │   │   ├── evm/
│   │   │   │   ├── oneInchAdapter.ts  # 1inch quote + swap building
│   │   │   │   └── approvalHelper.ts  # ERC-20 allowance check + approve tx
│   │   │   ├── solana/
│   │   │   │   └── jupiterAdapter.ts  # Jupiter quote + swapTransaction
│   │   │   └── bridge/
│   │   │       └── lifiAdapter.ts     # LI.FI route + step execution + status
│   │   ├── mock/
│   │   │   ├── mockQuotes.ts          # deterministic mock quote fixtures
│   │   │   ├── mockRoutes.ts          # deterministic mock bridge routes
│   │   │   └── mockStatus.ts          # deterministic mock status responses
│   │   ├── providers/
│   │   │   ├── wagmiConfig.ts         # wagmi + viem chain config
│   │   │   └── solanaConfig.ts        # solana wallet adapter config
│   │   ├── hooks/
│   │   │   ├── useQuote.ts            # fetches quote via API route
│   │   │   ├── useSwapExecution.ts    # manages swap tx lifecycle
│   │   │   ├── useBridgeExecution.ts  # manages bridge tx lifecycle + polling
│   │   │   ├── useApproval.ts         # ERC-20 approval flow
│   │   │   ├── useTokenBalance.ts     # balance fetching (EVM + Solana)
│   │   │   └── usePersistedRoute.ts   # localStorage resume tracking
│   │   ├── store/
│   │   │   └── transactionStore.ts    # localStorage persistence for routes/status
│   │   └── utils/
│   │       ├── formatters.ts          # number/address formatting
│   │       └── constants.ts           # status enums, defaults
│   │
│   └── __tests__/
│       ├── routing/
│       │   ├── routingEngine.test.ts       # auto-routes correctly
│       │   └── modeEnforcement.test.ts     # swap-only blocks cross-chain, bridge-only blocks same-chain
│       ├── adapters/
│       │   ├── oneInchAdapter.test.ts      # EVM quote + approval path
│       │   ├── jupiterAdapter.test.ts      # Solana swap quote/execution mocked
│       │   └── lifiAdapter.test.ts         # bridge route with step tracking
│       ├── schemas/
│       │   └── schemas.test.ts             # zod validation for all schemas
│       └── integration/
│           └── quoteFlow.test.ts           # end-to-end mocked quote → tx flow
```

---

## Proposed Changes by Phase

### Phase B — Core Foundation

#### [NEW] [chainConfig.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/chains/chainConfig.ts)
Chain definitions with RPC URLs, explorer base URLs, native currency, chain type (`evm` | `solana`).

#### [NEW] [tokenList.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/tokens/tokenList.ts)
Typed token list with verified addresses. Includes ETH/WETH/USDC/USDT per major chain, CANTO native on 7700. Uses `0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE` for native tokens.

#### [NEW] Zod schemas — `src/lib/schemas/*.ts`
Strict validation for every API boundary: `QuoteRequest`, `QuoteResponse`, `Route`, `RouteStep`, `TxRequest`, `StatusResponse`.

#### [NEW] [routingEngine.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/routing/routingEngine.ts)
Deterministic resolver: `(fromChain, toChain, fromToken, toToken, amount, mode, slippageBps) → Route | RoutingError`. Delegates to adapters.

#### [NEW] [modeEnforcement.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/routing/modeEnforcement.ts)
Mode rules returning structured errors with `code` + `message`.

---

### Phase C — Provider Adapters & API Routes

#### [NEW] [oneInchAdapter.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/adapters/evm/oneInchAdapter.ts)
Calls 1inch v6.0 `/quote` and `/swap` endpoints. Respects `MOCK_MODE`.

#### [NEW] [approvalHelper.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/adapters/evm/approvalHelper.ts)
Reads ERC-20 `allowance()`, builds `approve()` calldata if needed. Skips for native ETH.

#### [NEW] [jupiterAdapter.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/adapters/solana/jupiterAdapter.ts)
Calls Jupiter v6 `/quote` and `/swap` endpoints. Returns base64 `swapTransaction`.

#### [NEW] [lifiAdapter.ts](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/lib/adapters/bridge/lifiAdapter.ts)
Calls LI.FI `/v1/quote`, `/v1/advanced/routes`, `/v1/status`. Returns steps array for UI stepper.

#### [NEW] API routes — `src/app/api/**`
Server-side proxy routes that inject API keys from env vars and forward to providers.

#### [NEW] Mock fixtures — `src/lib/mock/*.ts`
Deterministic mock responses matching real provider shapes, gated by `MOCK_MODE=1`.

---

### Phase D — UI

#### [NEW] [providers.tsx](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/app/providers.tsx)
Wraps app with `WagmiProvider`, `SolanaWalletProvider`, `QueryClientProvider`.

#### [NEW] [SwapBridgeApp.tsx](file:///C:/Users/chris/.gemini/antigravity/scratch/swap-bridge-dapp/src/components/SwapBridgeApp.tsx)
Main orchestrator: holds state for from/to chain+token+amount, mode, quote, tx status.

#### [NEW] UI components — `src/components/*.tsx`
ModeToggle, ChainSelector, TokenSelector, AmountInput, QuotePanel, TransactionStepper, WalletConnectButton, plus shared primitives.

#### [NEW] Custom hooks — `src/lib/hooks/*.ts`
`useQuote`, `useSwapExecution`, `useBridgeExecution`, `useApproval`, `useTokenBalance`, `usePersistedRoute`.

---

### Phase E — Tests

Tests use vitest with mocked fetch/provider responses. No real API calls.

---

### Phase F — README & Run Instructions

Complete README with env var table, mock mode instructions, extension guide.

---

## User Review Required

> [!IMPORTANT]
> **Provider choices**: Using **1inch** (EVM swaps), **Jupiter** (Solana swaps), **LI.FI** (bridging). All three are free-tier-friendly with API keys. If you prefer different providers (e.g., 0x instead of 1inch, Socket instead of LI.FI), let me know before I start coding.

> [!WARNING]
> **API Keys Required for Production**: 1inch and LI.FI require API keys for production use. `MOCK_MODE=1` lets you run and test locally without any keys. The app will work fully in mock mode.

> [!NOTE]
> **Canto (7700)**: Canto is included in the chain config and token list. 1inch may have limited Canto support — the adapter will gracefully fall back to an error if a route isn't available. LI.FI does support Canto bridging.

---

## Verification Plan

### Automated Tests (vitest)

Run all tests:
```bash
cd C:\Users\chris\.gemini\antigravity\scratch\swap-bridge-dapp
npx vitest run
```

Specific test suites:

| Test | File | Validates |
|---|---|---|
| Mode enforcement | `modeEnforcement.test.ts` | SWAP ONLY blocks cross-chain; BRIDGE ONLY blocks same-chain |
| Routing engine | `routingEngine.test.ts` | AUTO routes same-chain → swap, cross-chain → bridge |
| EVM approval | `oneInchAdapter.test.ts` | Approval-required path for ERC-20 tokens |
| Solana swap | `jupiterAdapter.test.ts` | Jupiter quote + swapTransaction mocked |
| Bridge tracking | `lifiAdapter.test.ts` | Bridge route steps + status polling mocked |
| Schema validation | `schemas.test.ts` | Zod schemas accept valid, reject invalid data |
| Integration | `quoteFlow.test.ts` | Full mocked flow: quote → approve → execute |

### Manual Verification (Browser)

1. Start dev server: `npm run dev` (with `MOCK_MODE=1` in `.env.local`)
2. Open `http://localhost:3000`
3. Verify:
   - Both EVM and Solana wallet connect buttons render
   - Mode toggle switches between AUTO / SWAP ONLY / BRIDGE ONLY
   - Selecting same chain in BRIDGE ONLY shows error message
   - Selecting different chains in SWAP ONLY shows error message
   - AUTO mode shows route reasoning in quote panel
   - Mock quotes return and display in QuotePanel
   - Transaction stepper shows all steps
4. Refresh page — verify persisted mode and any in-flight route resumes
